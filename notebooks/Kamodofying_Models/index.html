<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Kamodofying Models - Kamodo Analysis Suite</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Kamodofying Models";
    var mkdocs_page_input_path = "notebooks/Kamodofying_Models.ipynb";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Kamodo Analysis Suite</a>
        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../about/">About</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../Kamodo/">Introduction</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../Visualization/">Visualization</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../Syntax/">Syntax</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Kamodofying Models</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#kamodofication-tutorial">Kamodofication Tutorial</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#kamodofication-requirements">Kamodofication requirements</a></li>
        
            <li><a class="toctree-l3" href="#model-reader-tutorial">Model Reader Tutorial</a></li>
        
            <li><a class="toctree-l3" href="#including-defaults">Including defaults</a></li>
        
            <li><a class="toctree-l3" href="#final-implementation">Final Implementation</a></li>
        
            <li><a class="toctree-l3" href="#combined-models">Combined models</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../FieldIntegration/">Field Integration</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../kameleon-kamodo/">Kameleon</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../TIEGCM/">TIEGCM</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Kamodo Analysis Suite</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
    
    <li>Kamodofying Models</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="kamodofication-tutorial">Kamodofication Tutorial<a class="headerlink" href="#kamodofication-tutorial" title="Permanent link">&para;</a></h1>
<p>This tutorial focuses on building a Kamodofied model from scratch. To see the full implementation, skip down to the <a href="#Final-Implementation">Final-Implementation</a>.</p>
<h2 id="kamodofication-requirements">Kamodofication requirements<a class="headerlink" href="#kamodofication-requirements" title="Permanent link">&para;</a></h2>
<p>To Kamodofy models and data representing physical quantities, we need to define a set of functions representing the interpolation of each physical variable having the following properties:</p>
<ul>
<li>A function name and arguments that follows kamodo's <a href="../Syntax/">Syntax</a> conventions </li>
<li>Default arrays for input arguments</li>
<li>A meta attribute containing:<ul>
<li>'units' - physical units of the values returned by the function</li>
<li>'citation' - How the model or data source should be cited</li>
<li>'equation' - LaTeX representation of this model/data source (if available)</li>
<li>'hidden_args' - A list of function arguments that should not be rendered</li>
</ul>
</li>
<li>A data attribute - The array holding the variable (if available)</li>
<li>Any docstrings that provide further context</li>
</ul>
<h2 id="model-reader-tutorial">Model Reader Tutorial<a class="headerlink" href="#model-reader-tutorial" title="Permanent link">&para;</a></h2>
<p>Model Readers load data from disk (or server) and provide methods for interpolation. We require that for each variable of interest, the model reader should provide at least one interpolation method that satisfies all of the above requirements. Each model reader will:</p>
<ol>
<li>Open/close files</li>
<li>Manage state variables</li>
<li>Initialize interpolators</li>
<li>Kamodofy interpolators</li>
<li>Register functions</li>
</ol>
<h3 id="minimal-example-one-variable">Minimal Example: one variable<a class="headerlink" href="#minimal-example-one-variable" title="Permanent link">&para;</a></h3>
<pre><code class="python">from kamodo import Kamodo, kamodofy, gridify
from scipy.interpolate import RegularGridInterpolator
import numpy as np
import plotly.io as pio
</code></pre>

<pre><code>/Users/apembrok/git/kamodo/kamodo/readers/__init__.py:7: UserWarning:

TIEGCM reader not installed
</code></pre>
<pre><code class="python">class MyModel(Kamodo): 
    def __init__(self, filename, **kwargs):
        # perform any necessary I/O
        print('opening {}'.format(filename))
        self.filename = filename
        self.missing_value = np.NAN

        # store any data needed for interpolation
        self.x = np.linspace(1, 4, 11)
        self.y = np.linspace(4, 7, 22)
        self.z = np.linspace(7, 9, 33) 

        xx, yy, zz = np.meshgrid(self.x, self.y, self.z, indexing='ij', sparse=True)
        density_data = 2 * xx**3 + 3 * yy**2 - zz

        self.interpolator = RegularGridInterpolator((self.x, self.y, self.z), density_data, 
                                                    bounds_error = False,
                                                   fill_value = self.missing_value)



        # Prepare model for function registration for the input argument
        super(MyModel, self).__init__(**kwargs) 

        # Wrap the interpolator with a nicer function signature
        @kamodofy(units = 'kg/m^3')
        def interpolator(xvec):
            return self.interpolator(xvec)

        self['rho(xvec)'] = interpolator


model = MyModel('myfile.dat')
model
</code></pre>

<pre><code>opening myfile.dat
</code></pre>
<p>
<script type="math/tex; mode=display">\begin{equation}\rho{\left(\vec{x} \right)} [kg/m^3] = \lambda{\left(\vec{x} \right)}\end{equation}</script>
</p>
<p>we can call the registered function with multiple values, getting <code>nan</code> if out of bounds:</p>
<pre><code class="python">model.rho([[2,5,8],
           [0,0,0]])
</code></pre>

<pre><code>array([83.244,    nan])
</code></pre>
<p>However, the registered function has no default parameters, so an error will be raised if we do not provide an argument.</p>
<pre><code class="python">try:
    model.rho()
except TypeError as m:
    print(m)
</code></pre>

<pre><code>interpolator() missing 1 required positional argument: 'xvec'
</code></pre>
<p>At this point, the end-user of the model cannot generate quick-look graphics:</p>
<pre><code class="python">try:
    model.plot('rho')
except TypeError as m:
    print(m)
</code></pre>

<pre><code>interpolator() missing 1 required positional argument: 'xvec'[]
</code></pre>
<p>In order to generate any plots, the user must already know where they can place resolution. For example, they could inspect some of the attributes of the model and guess the size of the domain, then choose points from that space.</p>
<pre><code class="python">xx,yy,zz = np.meshgrid(model.x, model.y, model.z)
points = np.column_stack([xx.ravel(),yy.ravel(),zz.ravel()])
randints = np.random.randint(0,len(points), 1000)
</code></pre>

<pre><code class="python">fig = model.plot(rho = dict(xvec = points[randints] ))
</code></pre>

<pre><code class="python">pio.write_image(fig, 'images/kamodofied1.svg')
</code></pre>

<p><img alt="kamodofied1" src="../images/kamodofied1.svg" /></p>
<p>Hopefully, the user doesn't choose points where the solution may be invalid. Next, we'll modify the original function to provide a griddable variable with default parameters.</p>
<h2 id="including-defaults">Including defaults<a class="headerlink" href="#including-defaults" title="Permanent link">&para;</a></h2>
<p>The above example produced a kamodofied model with one variable, but we are unable to produce quick-look graphics, which required the user to inspect the model to guess where interpolation may be valid. Here we show how to include defaults so the user doesn't have to guess.</p>
<pre><code class="python">class MyModel(Kamodo): 
    def __init__(self, filename, **kwargs):
        # perform any necessary I/O
        print('opening {}'.format(filename))
        self.filename = filename
        self.missing_value = np.NAN

        # store any data needed for interpolation
        self.x = np.linspace(1, 4, 11)
        self.y = np.linspace(4, 7, 22)
        self.z = np.linspace(7, 9, 33) 

        xx, yy, zz = np.meshgrid(self.x, self.y, self.z, indexing='ij', sparse=True)
        density_data = 2 * xx**3 + 3 * yy**2 - zz

        self.interpolator = RegularGridInterpolator((self.x, self.y, self.z), density_data, 
                                                    bounds_error = False,
                                                   fill_value = self.missing_value)



        # Prepare model for function registration for the input argument
        super(MyModel, self).__init__(**kwargs) 

        # Wrap the interpolator with a nicer function signature
        @kamodofy(units = 'kg/m^3')
        @gridify(x = self.x, y = self.y, z = self.z) # &lt;--- The only change to the model
        def interpolator(xvec):
            return self.interpolator(xvec)

        self['rho'] = interpolator


model = MyModel('myfile.dat')
model
</code></pre>

<pre><code>opening myfile.dat
</code></pre>
<p>
<script type="math/tex; mode=display">\begin{equation}\rho{\left(x,y,z \right)} [kg/m^3] = \lambda{\left(x,y,z \right)}\end{equation}</script>
</p>
<p>By adding the <code>@gridify</code> line, we have modified the original function to be one that generates gridded data. Moreover, the variable now has default parameters.</p>
<pre><code class="python">model.rho().shape
</code></pre>

<pre><code>(22, 11, 33)
</code></pre>
<p>We can now specify one or more arguments to get a plane mapping of the solution.</p>
<pre><code class="python">model.rho(z = 8).shape
</code></pre>

<pre><code>(22, 11, 1)
</code></pre>
<p>But how do we know to choose the plane <code>z=8</code> for a valid solution? We can use kamodo's function inspection to get the default ranges for each parameter.</p>
<pre><code class="python">from kamodo import get_defaults
</code></pre>

<pre><code class="python">get_defaults(model.rho)['z'].mean()
</code></pre>

<pre><code>8.0
</code></pre>
<h2 id="final-implementation">Final Implementation<a class="headerlink" href="#final-implementation" title="Permanent link">&para;</a></h2>
<p>In the final implementation of our model reader, we include multiple variables with different function signatures. Here, the gridded solutions have suffixes <code>_ijk</code> to emphasize their structure. This allows more flexibility for the end user.</p>
<pre><code class="python">class MyModel(Kamodo): 
    def __init__(self, filename, **kwargs):
        # perform any necessary I/O
        print('opening {}'.format(filename))
        self.filename = filename
        self.missing_value = np.NAN

        # store any data needed for interpolation
        self.x = np.linspace(1, 4, 11)
        self.y = np.linspace(4, 7, 22)
        self.z = np.linspace(7, 9, 33)        
        xx, yy, zz = np.meshgrid(self.x, self.y, self.z, indexing='ij', sparse=True)
        density_data = 2 * xx**3 + 3 * yy**2 - zz
        pressure_data = xx**2 + yy**2 + zz**2


        self.variables = dict(rho = dict(units = 'kg/m^3', data = density_data),
                              P = dict(units = 'nPa', data = pressure_data))

        # Prepare model for function registration
        super(MyModel, self).__init__(**kwargs) 

        for varname in self.variables:
            units = self.variables[varname]['units']
            self.register_variable(varname, units)

    def register_variable(self, varname, units):
        interpolator = self.get_grid_interpolator(varname)

        # store the interpolator
        self.variables[varname]['interpolator'] = interpolator

        def interpolate(xvec):  
            return self.variables[varname]['interpolator'](xvec)

        # update docstring for this variable
        interpolate.__doc__ = &quot;A function that returns {} in [{}].&quot;.format(varname,units)

        self[varname] = kamodofy(interpolate, 
                           units = units, 
                           citation = &quot;Pembroke et al 2019&quot;,
                          data = None)
        self[varname + '_ijk'] = kamodofy(gridify(self[varname], 
                                                  x_i = self.x, 
                                                  y_j = self.y, 
                                                  z_k = self.z),
                            units = units,
                            citation = &quot;Pembroke et al 2019&quot;,
                            data = self.variables[varname]['data'])


    def get_grid_interpolator(self, varname):
        &quot;&quot;&quot;create a regulard grid interpolator for this variable&quot;&quot;&quot;
        data =  self.variables[varname]['data']

        interpolator = RegularGridInterpolator((self.x, self.y, self.z), data, 
                                                bounds_error = False,
                                               fill_value = self.missing_value)
        return interpolator


model = MyModel('myfile.dat')
model
</code></pre>

<pre><code>opening myfile.dat
</code></pre>
<p>
<script type="math/tex; mode=display">\begin{equation}\rho{\left(\vec{x} \right)} [kg/m^3] = \lambda{\left(\vec{x} \right)}\end{equation}</script>
<script type="math/tex; mode=display">\begin{equation}\rho_{ijk}{\left(x_{i},y_{j},z_{k} \right)} [kg/m^3] = \lambda{\left(x_{i},y_{j},z_{k} \right)}\end{equation}</script>
<script type="math/tex; mode=display">\begin{equation}P{\left(\vec{x} \right)} [nPa] = \lambda{\left(\vec{x} \right)}\end{equation}</script>
<script type="math/tex; mode=display">\begin{equation}\operatorname{P_{ijk}}{\left(x_{i},y_{j},z_{k} \right)} [nPa] = \lambda{\left(x_{i},y_{j},z_{k} \right)}\end{equation}</script>
</p>
<pre><code class="python">model.rho((2,5,8))
</code></pre>

<pre><code>array(83.244)
</code></pre>
<pre><code class="python">model.P((2,5,8))
</code></pre>

<pre><code>array(93.02)
</code></pre>
<pre><code class="python">model.detail()
</code></pre>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>lhs</th>
      <th>rhs</th>
      <th>symbol</th>
      <th>units</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>rho(xvec)</th>
      <td>rho</td>
      <td>None</td>
      <td>rho(xvec)</td>
      <td>kg/m^3</td>
    </tr>
    <tr>
      <th>rho_ijk(x_i, y_j, z_k)</th>
      <td>rho_ijk</td>
      <td>None</td>
      <td>rho_ijk(x_i, y_j, z_k)</td>
      <td>kg/m^3</td>
    </tr>
    <tr>
      <th>P(xvec)</th>
      <td>P</td>
      <td>None</td>
      <td>P(xvec)</td>
      <td>nPa</td>
    </tr>
    <tr>
      <th>P_ijk(x_i, y_j, z_k)</th>
      <td>P_ijk</td>
      <td>None</td>
      <td>P_ijk(x_i, y_j, z_k)</td>
      <td>nPa</td>
    </tr>
  </tbody>
</table>
</div>

<p>Here the <code>@kamodofy</code> decorator handles the provisioning of kamodo-specific metadata. For example, the declared function <code>rho</code> now has a <code>meta</code> attribute:</p>
<pre><code class="python">model.rho.meta
</code></pre>

<pre><code>{'units': 'kg/m^3',
 'citation': 'Pembroke et al 2019',
 'equation': None,
 'hidden_args': []}
</code></pre>
<p><code>@kamodofy</code> also adds the data attribute, by calling the function with its default parameters:</p>
<pre><code class="python">model.rho_ijk.data.shape
</code></pre>

<pre><code>(11, 22, 33)
</code></pre>
<h2 id="combined-models">Combined models<a class="headerlink" href="#combined-models" title="Permanent link">&para;</a></h2>
<p>We could also register the model's interpolating method as part of some other Kamodo object, such as another kamodofied model reader or data source:</p>
<pre><code class="python">from kamodo import Kamodo
kamodo = Kamodo(rho = model.rho)
kamodo
</code></pre>

<p>
<script type="math/tex; mode=display">\begin{equation}\rho{\left(\vec{x} \right)} [kg/m^3] = \lambda{\left(\vec{x} \right)}\end{equation}</script>
</p>
<p>We can now compose our density function with expressions defined by other models:</p>
<pre><code class="python">kamodo['vol [cm^3]'] = '4/3 * pi * (x**2 + y**2)**(3/2)'
kamodo['mass [g]'] = 'rho*vol'
kamodo
</code></pre>

<p>
<script type="math/tex; mode=display">\begin{equation}\rho{\left(\vec{x} \right)} [kg/m^3] = \lambda{\left(\vec{x} \right)}\end{equation}</script>
<script type="math/tex; mode=display">\begin{equation}\operatorname{vol}{\left(x,y \right)} [cm^3] = \frac{4 \pi \left(x^{2} + y^{2}\right)^{\frac{3}{2}}}{3}\end{equation}</script>
<script type="math/tex; mode=display">\begin{equation}\operatorname{mass}{\left(x,\vec{x},y \right)} [g] = \frac{\rho{\left(\vec{x} \right)} \operatorname{vol}{\left(x,y \right)}}{1000}\end{equation}</script>
</p>
<pre><code class="python">kamodo.detail()
</code></pre>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>lhs</th>
      <th>rhs</th>
      <th>symbol</th>
      <th>units</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>rho(xvec)</th>
      <td>rho</td>
      <td>None</td>
      <td>rho(xvec)</td>
      <td>kg/m^3</td>
    </tr>
    <tr>
      <th>vol(x, y)</th>
      <td>vol</td>
      <td>4*pi*(x**2 + y**2)**(3/2)/3</td>
      <td>vol(x, y)</td>
      <td>cm^3</td>
    </tr>
    <tr>
      <th>mass(x, xvec, y)</th>
      <td>mass</td>
      <td>rho(xvec)*vol(x, y)/1000</td>
      <td>mass(x, xvec, y)</td>
      <td>g</td>
    </tr>
  </tbody>
</table>
</div>

<p>The following lines will save the image to your working directory.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Saving images requires <code>plotly-orca-1.2.1</code>, available through conda: <code>conda install -c plotly plotly-orca</code></p>
</div>
<pre><code class="python">model.rho_ijk().shape
</code></pre>

<pre><code>(22, 11, 33)
</code></pre>
<pre><code class="python">import plotly.io as pio
fig = model.plot(rho_ijk = dict(z_k = model.z.mean()))
</code></pre>

<pre><code class="python">from plotly.offline import iplot, init_notebook_mode, plot
</code></pre>

<pre><code class="python">init_notebook_mode(connected = True)
</code></pre>

<script type="text/javascript">
window.PlotlyConfig = {MathJaxConfig: 'local'};
if (window.MathJax) {MathJax.Hub.Config({SVG: {font: "STIX-Web"}});}
if (typeof require !== 'undefined') {
require.undef("plotly");
requirejs.config({
    paths: {
        'plotly': ['https://cdn.plot.ly/plotly-latest.min']
    }
});
require(['plotly'], function(Plotly) {
    window._Plotly = Plotly;
});
}
</script>

<pre><code class="python">fig = model.plot(rho_ijk =  dict(z_k = [model.z.mean()]))
</code></pre>

<pre><code class="python">pio.write_image(fig, 'kamodofied_model_1.svg', validate = False)
</code></pre>

<p>We use markdown to embed the image into the notebook.
<img alt="Kamodofied Density" src="../kamodofied_model_1.svg?5" /></p>
<p>Alternative ways to graph:</p>
<pre><code class="python">## uncomment to open interactive plot in the notebook
# from plotly.offline import init_notebook_mode, iplot
# init_notebook_mode(connected = True)
# iplot(kamodo.plot(rho = dict(x = model.x.mean()))) 
</code></pre>

<pre><code class="python"># # uncomment to open interactive plot in separate tab
# from plotly.offline import plot
# plot(kamodo.plot(rho = dict(z = 8))) 
</code></pre>

<pre><code class="python">%load_ext autoreload

%autoreload 2
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../FieldIntegration/" class="btn btn-neutral float-right" title="Field Integration">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../Syntax/" class="btn btn-neutral" title="Syntax"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../Syntax/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../FieldIntegration/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" defer></script>

</body>
</html>
