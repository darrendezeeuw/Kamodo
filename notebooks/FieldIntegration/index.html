<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Field Integration - Kamodo Analysis Suite</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Field Integration";
    var mkdocs_page_input_path = "notebooks/FieldIntegration.ipynb";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Kamodo Analysis Suite</a>
        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../about/">About</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../Kamodo/">Introduction</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../Visualization/">Visualization</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../Syntax/">Syntax</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../Kamodofying_Models/">Kamodofying Models</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">Field Integration</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#field-integration-techniques">Field Integration Techniques</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#dipole-field-model">Dipole field model</a></li>
        
            <li><a class="toctree-l3" href="#normalization">Normalization</a></li>
        
            <li><a class="toctree-l3" href="#solving-the-initial-value-problem">Solving the initial value problem</a></li>
        
            <li><a class="toctree-l3" href="#evaluating-the-solutions">Evaluating the Solutions</a></li>
        
            <li><a class="toctree-l3" href="#complex-parameterization">Complex parameterization</a></li>
        
            <li><a class="toctree-l3" href="#plotting-fieldlines">Plotting Fieldlines</a></li>
        
            <li><a class="toctree-l3" href="#integration-totals">Integration totals</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../kameleon-kamodo/">Kameleon</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../TIEGCM/">TIEGCM</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Kamodo Analysis Suite</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
    
    <li>Field Integration</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="field-integration-techniques">Field Integration Techniques<a class="headerlink" href="#field-integration-techniques" title="Permanent link">&para;</a></h1>
<p>Many analysis techniques for vector fields require solving an initial value problem for an arbitrary set of seed points and evaluating such solutions at a chosen resolution. Kamodo makes it easy to generate fieldline solutions by providing a function decorator that wraps scipy's powerful <code>solve_ivp</code> function. Each family of solutions is represented by a single function of a complex parameter. We illustrate the flexibility of this approach in the example below.</p>
<pre><code class="python"># initialize
from plotly.offline import iplot, plot, init_notebook_mode
# init_notebook_mode(connected = True)

from kamodo import Kamodo, event, pointlike, kamodofy, solve
import numpy as np
import pandas as pd
</code></pre>

<h2 id="dipole-field-model">Dipole field model<a class="headerlink" href="#dipole-field-model" title="Permanent link">&para;</a></h2>
<p>We use the following dipole field model that can accept (m,) and (1,m), and (n,m) arrays.</p>
<pre><code class="python">def Bdip(rvec):
    &quot;&quot;&quot;Need math to work in a variety of arg shapes&quot;&quot;&quot;
    muvec = Bdip.muvec    
    r = np.linalg.norm(rvec, axis = 1)
    r[r==0] = np.nan

    try:
        rhat = rvec/r
    except:
        rhat = (rvec.T/r).T

    try:
        result = 3*np.dot(rhat, muvec.T)
    except:
        result = 3*np.dot(rhat.T, muvec.T).T


    result = (rhat.T*result).T

    try:
        result = result - muvec
    except:
        result = (result - muvec.T).T

    try:
        result = result/r**3
    except:
        result = (result.T/r**3).T

    return result

# set dipole moment
Bdip.muvec = np.array([0, 0, -1]) 

# pointlike enforces dimensionality
Bdip = pointlike(Bdip, '(n,m)-&gt;(n,m)', [np.float], squeeze = 0)
</code></pre>

<pre><code class="python">kamodo = Kamodo()
</code></pre>

<pre><code class="python">kamodo['Bvec'] = Bdip # register the dipole field
kamodo
</code></pre>

<p>
<script type="math/tex; mode=display">\begin{equation}\vec{B}{\left(\vec{r} \right)} = \lambda{\left(\vec{r} \right)}\end{equation}</script>
</p>
<h2 id="normalization">Normalization<a class="headerlink" href="#normalization" title="Permanent link">&para;</a></h2>
<p>Instead of solving the initial value problem on the original field, we will be solving on the normalized field. This will mean that the integral path is the same as the arclength, allowing us to control the visual fidelity of the resulting field.</p>
<p>Create a normalization function to be applied to our field</p>
<pre><code class="python">@kamodofy(equation = &quot;$$\\hat{n}(\\vec{y}) = \\vec{y}/\\sqrt{\\vec{y} \\cdot \\vec{y}} $$&quot;)
@pointlike(signature = '(m,n)-&gt;(m,n)', squeeze = 0)
def normalized(yvec):   
    r = np.linalg.norm(yvec, axis = 1)
    r[r==0] = np.nan

    try:
        return yvec/r
    except:
        return (yvec.T/r).T


kamodo['nhat'] = normalized
</code></pre>

<p>Create a normalized field</p>
<pre><code class="python">kamodo['bhat'] = &quot;nhat(Bvec)&quot;
kamodo
</code></pre>

<p>
<script type="math/tex; mode=display">\begin{equation}\vec{B}{\left(\vec{r} \right)} = \lambda{\left(\vec{r} \right)}\end{equation}</script>
<script type="math/tex; mode=display">\hat{n}(\vec{y}) = \vec{y}/\sqrt{\vec{y} \cdot \vec{y}} </script>
<script type="math/tex; mode=display">\begin{equation}\hat{b}{\left(\vec{r} \right)} = \hat{n}{\left(\vec{B}{\left(\vec{r} \right)} \right)}\end{equation}</script>
</p>
<h2 id="solving-the-initial-value-problem">Solving the initial value problem<a class="headerlink" href="#solving-the-initial-value-problem" title="Permanent link">&para;</a></h2>
<p>Generate a set of seed points for integration</p>
<pre><code class="python">x0 = np.linspace(-np.pi,np.pi,6)
y0 = np.linspace(-np.pi,np.pi,6)
z0 = 1

seeds = np.array(np.column_stack([c.ravel() for c in np.meshgrid(x0,y0,z0)]))
</code></pre>

<p>Create a stopping boundary for field line integrator</p>
<pre><code class="python">@event
def boundary(s, rvec):
    r = np.linalg.norm(rvec)

    if np.isnan(r):
        result = 0
    else:
        result = r - 1
    return result

</code></pre>

<p>Solve the initial value problem for the normalized field</p>
<pre><code class="python">kamodo['svec'] = solve(kamodo.bhat, # the field to be solved
                       seeds, # the initial positions
                       's', # the name of the integration parameter
                       (0,30), # the span to integrate over
                       npoints = 60, # the number of points to evaluate the solution
                       events = boundary, # stop at the boundary
                      )
kamodo
</code></pre>

<p>
<script type="math/tex; mode=display">\begin{equation}\vec{B}{\left(\vec{r} \right)} = \lambda{\left(\vec{r} \right)}\end{equation}</script>
<script type="math/tex; mode=display">\hat{n}(\vec{y}) = \vec{y}/\sqrt{\vec{y} \cdot \vec{y}} </script>
<script type="math/tex; mode=display">\begin{equation}\hat{b}{\left(\vec{r} \right)} = \hat{n}{\left(\vec{B}{\left(\vec{r} \right)} \right)}\end{equation}</script>
<script type="math/tex; mode=display">\begin{equation}\vec{s}{\left(s \right)} = \lambda{\left(s \right)}\end{equation}</script>
</p>
<p>The solver returns a family of solutions, represented as a single function of a complex array, <script type="math/tex">\vec{s}(s)</script> where
<script type="math/tex">s</script> is a complex array. </p>
<h2 id="evaluating-the-solutions">Evaluating the Solutions<a class="headerlink" href="#evaluating-the-solutions" title="Permanent link">&para;</a></h2>
<p>On evaluation, <script type="math/tex">\vec{s}(s)</script> returns a pandas dataframe.</p>
<pre><code class="python">kamodo.svec().head()
</code></pre>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
    </tr>
    <tr>
      <th>seed</th>
      <th>integral</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">0.0</th>
      <th>-6.610169</th>
      <td>-0.347554</td>
      <td>-0.347554</td>
      <td>-0.924068</td>
    </tr>
    <tr>
      <th>-6.101695</th>
      <td>-0.615865</td>
      <td>-0.615865</td>
      <td>-1.261579</td>
    </tr>
    <tr>
      <th>-5.593220</th>
      <td>-0.922720</td>
      <td>-0.922720</td>
      <td>-1.525495</td>
    </tr>
    <tr>
      <th>-5.084746</th>
      <td>-1.256963</td>
      <td>-1.256963</td>
      <td>-1.713145</td>
    </tr>
    <tr>
      <th>-4.576271</th>
      <td>-1.608411</td>
      <td>-1.608411</td>
      <td>-1.822192</td>
    </tr>
  </tbody>
</table>
</div>

<p>When using the default argument above, the solution evaluates at a resolution of npoints/span, stopping at the boundary.</p>
<h2 id="complex-parameterization">Complex parameterization<a class="headerlink" href="#complex-parameterization" title="Permanent link">&para;</a></h2>
<p>Kamodo represents the family of solutions to the initial value problem as a single function of a complex array.</p>
<p>The floor of the real part of the input parameter corresponds to the original seed array:</p>
<pre><code class="python">kamodo.svec([0,1,2]).values
</code></pre>

<pre><code>array([[-3.14159265, -3.14159265,  1.        ],
       [-1.88495559, -3.14159265,  1.        ],
       [-0.62831853, -3.14159265,  1.        ]])
</code></pre>
<p>compare with original seeds:</p>
<pre><code class="python">seeds[[0,1,2]]
</code></pre>

<pre><code>array([[-3.14159265, -3.14159265,  1.        ],
       [-1.88495559, -3.14159265,  1.        ],
       [-0.62831853, -3.14159265,  1.        ]])
</code></pre>
<p>The imaginary part denotes the integral along the corresponding solution. Here, we can choose evaluation points that were not in the original solution. Parameters outside the original span will be extrapolated.</p>
<pre><code class="python">kamodo.svec([-6j, -5j, 0, 5j, 6j, 4 + 4j, 4 -5.777j])
</code></pre>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
    </tr>
    <tr>
      <th>seed</th>
      <th>integral</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">0.0</th>
      <th>-6.000</th>
      <td>-0.674467</td>
      <td>-0.674467</td>
      <td>-1.320541</td>
    </tr>
    <tr>
      <th>-5.000</th>
      <td>-1.314574</td>
      <td>-1.314574</td>
      <td>-1.737228</td>
    </tr>
    <tr>
      <th>0.000</th>
      <td>-3.141593</td>
      <td>-3.141593</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>5.000</th>
      <td>-0.120683</td>
      <td>-0.120683</td>
      <td>0.491788</td>
    </tr>
    <tr>
      <th>6.000</th>
      <td>0.115024</td>
      <td>0.115024</td>
      <td>-0.404619</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">4.0</th>
      <th>4.000</th>
      <td>0.094188</td>
      <td>-0.156979</td>
      <td>0.481816</td>
    </tr>
    <tr>
      <th>-5.777</th>
      <td>0.234822</td>
      <td>-0.391371</td>
      <td>-0.826931</td>
    </tr>
  </tbody>
</table>
</div>

<h2 id="plotting-fieldlines">Plotting Fieldlines<a class="headerlink" href="#plotting-fieldlines" title="Permanent link">&para;</a></h2>
<p>We can quickly generate plots for all fieldlines at the default resolution by calling plot with the name of the fieldlines solution.</p>
<pre><code class="python">import plotly.io as pio
</code></pre>

<pre><code class="python">fig = kamodo.plot('svec')
pio.write_image(fig, 'images/fieldlines.svg')
</code></pre>

<p><img alt="images/fieldlines.svg" src="../images/fieldlines.svg" /></p>
<p>To show the direction of the field at each point, we can evaluate <script type="math/tex">\hat{B}(\vec{s}(s))</script>
</p>
<pre><code class="python">fig = kamodo.plot('svec', 
                  Bhat = dict(rvec = kamodo.svec()))
pio.write_image(fig,'images/fieldlines_vectors.svg')
</code></pre>

<p><img alt="fieldlines" src="../images/fieldlines_vectors.svg" /></p>
<h2 id="integration-totals">Integration totals<a class="headerlink" href="#integration-totals" title="Permanent link">&para;</a></h2>
<p>To compute the total integral for each fieldline individually, we need a function to subtract the integration results at the endpoints.</p>
<pre><code class="python">def integral(fieldline):
    endpoints = fieldline.reset_index().integral.iloc[[0,-1]]
    return endpoints.values[-1] - endpoints.values[0]
</code></pre>

<pre><code class="python">totals = []
for seed, fieldline in kamodo.svec().groupby(level = 'seed'):
    totals.append(integral(fieldline))

totals[:5]
</code></pre>

<pre><code>[10.677966101694915,
 8.64406779661017,
 7.627118644067796,
 7.627118644067796,
 8.64406779661017]
</code></pre>
<p>Alternatively, we can use pandas' aggregation methods to apply our function on each fieldline.</p>
<pre><code class="python">pd.DataFrame.groupby.a
</code></pre>

<pre><code class="python">kamodo.svec().groupby(level='seed').aggregate(integral)
</code></pre>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
    </tr>
    <tr>
      <th>seed</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0.0</th>
      <td>10.677966</td>
      <td>10.677966</td>
      <td>10.677966</td>
    </tr>
    <tr>
      <th>1.0</th>
      <td>8.644068</td>
      <td>8.644068</td>
      <td>8.644068</td>
    </tr>
    <tr>
      <th>2.0</th>
      <td>7.627119</td>
      <td>7.627119</td>
      <td>7.627119</td>
    </tr>
    <tr>
      <th>3.0</th>
      <td>7.627119</td>
      <td>7.627119</td>
      <td>7.627119</td>
    </tr>
    <tr>
      <th>4.0</th>
      <td>8.644068</td>
      <td>8.644068</td>
      <td>8.644068</td>
    </tr>
    <tr>
      <th>5.0</th>
      <td>10.677966</td>
      <td>10.677966</td>
      <td>10.677966</td>
    </tr>
    <tr>
      <th>6.0</th>
      <td>8.644068</td>
      <td>8.644068</td>
      <td>8.644068</td>
    </tr>
    <tr>
      <th>7.0</th>
      <td>6.610169</td>
      <td>6.610169</td>
      <td>6.610169</td>
    </tr>
    <tr>
      <th>8.0</th>
      <td>5.084746</td>
      <td>5.084746</td>
      <td>5.084746</td>
    </tr>
    <tr>
      <th>9.0</th>
      <td>5.084746</td>
      <td>5.084746</td>
      <td>5.084746</td>
    </tr>
    <tr>
      <th>10.0</th>
      <td>6.610169</td>
      <td>6.610169</td>
      <td>6.610169</td>
    </tr>
    <tr>
      <th>11.0</th>
      <td>8.644068</td>
      <td>8.644068</td>
      <td>8.644068</td>
    </tr>
    <tr>
      <th>12.0</th>
      <td>7.627119</td>
      <td>7.627119</td>
      <td>7.627119</td>
    </tr>
    <tr>
      <th>13.0</th>
      <td>5.084746</td>
      <td>5.084746</td>
      <td>5.084746</td>
    </tr>
    <tr>
      <th>14.0</th>
      <td>5.593220</td>
      <td>5.593220</td>
      <td>5.593220</td>
    </tr>
    <tr>
      <th>15.0</th>
      <td>5.593220</td>
      <td>5.593220</td>
      <td>5.593220</td>
    </tr>
    <tr>
      <th>16.0</th>
      <td>5.084746</td>
      <td>5.084746</td>
      <td>5.084746</td>
    </tr>
    <tr>
      <th>17.0</th>
      <td>7.627119</td>
      <td>7.627119</td>
      <td>7.627119</td>
    </tr>
    <tr>
      <th>18.0</th>
      <td>7.627119</td>
      <td>7.627119</td>
      <td>7.627119</td>
    </tr>
    <tr>
      <th>19.0</th>
      <td>5.084746</td>
      <td>5.084746</td>
      <td>5.084746</td>
    </tr>
    <tr>
      <th>20.0</th>
      <td>5.593220</td>
      <td>5.593220</td>
      <td>5.593220</td>
    </tr>
    <tr>
      <th>21.0</th>
      <td>5.593220</td>
      <td>5.593220</td>
      <td>5.593220</td>
    </tr>
    <tr>
      <th>22.0</th>
      <td>5.084746</td>
      <td>5.084746</td>
      <td>5.084746</td>
    </tr>
    <tr>
      <th>23.0</th>
      <td>7.627119</td>
      <td>7.627119</td>
      <td>7.627119</td>
    </tr>
    <tr>
      <th>24.0</th>
      <td>8.644068</td>
      <td>8.644068</td>
      <td>8.644068</td>
    </tr>
    <tr>
      <th>25.0</th>
      <td>6.610169</td>
      <td>6.610169</td>
      <td>6.610169</td>
    </tr>
    <tr>
      <th>26.0</th>
      <td>5.084746</td>
      <td>5.084746</td>
      <td>5.084746</td>
    </tr>
    <tr>
      <th>27.0</th>
      <td>5.084746</td>
      <td>5.084746</td>
      <td>5.084746</td>
    </tr>
    <tr>
      <th>28.0</th>
      <td>6.610169</td>
      <td>6.610169</td>
      <td>6.610169</td>
    </tr>
    <tr>
      <th>29.0</th>
      <td>8.644068</td>
      <td>8.644068</td>
      <td>8.644068</td>
    </tr>
    <tr>
      <th>30.0</th>
      <td>10.677966</td>
      <td>10.677966</td>
      <td>10.677966</td>
    </tr>
    <tr>
      <th>31.0</th>
      <td>8.644068</td>
      <td>8.644068</td>
      <td>8.644068</td>
    </tr>
    <tr>
      <th>32.0</th>
      <td>7.627119</td>
      <td>7.627119</td>
      <td>7.627119</td>
    </tr>
    <tr>
      <th>33.0</th>
      <td>7.627119</td>
      <td>7.627119</td>
      <td>7.627119</td>
    </tr>
    <tr>
      <th>34.0</th>
      <td>8.644068</td>
      <td>8.644068</td>
      <td>8.644068</td>
    </tr>
    <tr>
      <th>35.0</th>
      <td>10.677966</td>
      <td>10.677966</td>
      <td>10.677966</td>
    </tr>
  </tbody>
</table>
</div>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../kameleon-kamodo/" class="btn btn-neutral float-right" title="Kameleon">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../Kamodofying_Models/" class="btn btn-neutral" title="Kamodofying Models"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../Kamodofying_Models/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../kameleon-kamodo/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" defer></script>

</body>
</html>
